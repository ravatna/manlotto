"use strict";let app=angular.module("Auth",["angular.filter","ui.router","ui.bootstrap","ngSanitize"]);app.config(["$stateProvider","$urlRouterProvider",function(e,r){e.state({name:"login",url:"/",templateUrl:"assets/templates/auth/login.html",controller:"LoginCtrl"}),r.otherwise(function(e){e.get("$state").go("login")})}]),app.directive("loading",["$http",function(e){return{restrict:"A",link:function(r,t,o){r.isLoading=function(){return e.pendingRequests.length>0},r.$watch(r.isLoading,function(e){e?t.show():t.hide()})}}}]),app.controller("LoginCtrl",["$window","$scope","$q","AuthService",function(e,r,t,o){o.currentLogin().then(function(r){"success"==r.result&&(e.location.href=r.profile.member_url)}),r.isLoginFailed=!1,r.formError={username:!1,password:!1},r.account={access:"login",username:"",password:"",remember:!1,scr_code:""},r.formErrorText={scr_code:""},r.Login=function(){r.isLoginFailed=!1,r.formError={username:!r.formLogin.username.$valid,password:!r.formLogin.password.$valid},r.formLogin.$valid?o.Login(r.account).then(function(t){"success"==t.result?e.location.href=t.profile.member_url:"error"==t.result?(r.isLoginFailed=!0,r.loginFailedText='<div class="alert alert-danger" role="alert"><strong>เข้าสู่ระบบไม่สำเร็จ!</strong> '+t.errorText+"</div>",r.getCaptcha()):"error-scr"==t.result&&(r.formError[t.filed]=!0,r.account[t.filed]="",r.formErrorText[t.filed]=t.errorText,angular.element('input[name="'+t.filed+'"]')[0].focus(),r.getCaptcha())}):r.getCaptcha()},r.getCaptcha=function(){var e=t.defer();return o.getCaptcha().then(function(t){r.srcCaptcha=t.captcha,e.resolve(t)}),e.promise}}]),app.factory("AuthService",["$q","$http",function(e,r){return this.getCaptcha=function(){let t=e.defer();return r.post("./api/captcha").then(function(e){t.resolve(e.data)}),t.promise},this.Login=function(t){let o=e.defer();return r.post("./api/login",t).then(function(e){o.resolve(e.data)}),o.promise},this.currentLogin=function(){let t=e.defer();return r.get("./api/login").then(function(e){t.resolve(e.data)}),t.promise},this}]);